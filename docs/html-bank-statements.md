# Поддержка HTML банковских выписок

## Обзор

Система теперь поддерживает загрузку банковских выписок в формате HTML. Это особенно полезно для банков, которые предоставляют выписки в виде веб-страниц.

## Поддерживаемые форматы

- **HTML (.html, .htm)** - Веб-страницы с таблицами транзакций
- **CSV (.csv, .txt)** - Текстовые файлы с разделителями
- **OFX (.ofx)** - Стандартный банковский формат
- **XLSX (.xlsx, .xls)** - Excel файлы (базовая поддержка)

## Как работает HTML парсер

### 1. Поиск таблицы транзакций

Парсер ищет таблицы по следующим селекторам (в порядке приоритета):
- `table.transactions`
- `table[class*="transaction"]`
- `table[id*="transaction"]`
- `table[class*="operation"]`
- `table[id*="operation"]`
- `.transactions table`
- `.operations table`
- `table` (любая таблица)

### 2. Извлечение заголовков

- Ищет заголовки в `<thead>` или первой строке таблицы
- Очищает текст от HTML артефактов
- Декодирует HTML сущности (&nbsp;, &amp;, и т.д.)

### 3. Обработка данных

- Извлекает все строки данных из `<tbody>` или всей таблицы
- Пропускает заголовочные строки
- Фильтрует итоговые/футерные строки
- Специальная обработка денежных сумм

### 4. Очистка данных

- Удаляет лишние пробелы и переносы строк
- Очищает денежные суммы от валютных символов
- Сохраняет знаки плюс/минус для сумм
- Декодирует HTML сущности

## Автоматическое определение столбцов

Система автоматически определяет назначение столбцов по заголовкам:

### Сумма операции
- "сумма", "amount", "деньги", "money"
- "операции", "операция"

### Описание операции
- "описание", "description", "назначение", "memo"
- "комментарий", "comment", "место", "получатель"
- "контрагент"

### Дата операции
- "дата", "date"

### Баланс счета
- "баланс", "balance", "остаток"

## Примеры поддерживаемых структур

### Простая таблица
```html
<table class="transactions">
  <thead>
    <tr>
      <th>Дата</th>
      <th>Описание</th>
      <th>Сумма</th>
      <th>Остаток</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>01.12.2024</td>
      <td>Покупка в магазине</td>
      <td>-1 250,50</td>
      <td>48 749,50</td>
    </tr>
  </tbody>
</table>
```

### Сложная структура с классами
```html
<table class="operations-table">
  <tr>
    <th>Дата операции</th>
    <th>Место проведения</th>
    <th class="amount-col">Сумма операции</th>
  </tr>
  <tr>
    <td>01.12.2024</td>
    <td>МАГАЗИН "ПЯТЕРОЧКА"</td>
    <td class="expense">-1 234,56 руб.</td>
  </tr>
</table>
```

## Обработка денежных сумм

Парсер распознает денежные ячейки по:
- CSS классам: `debit`, `credit`, `amount`, `sum`
- Содержимому: числа с валютными символами
- Контексту: столбцы с денежными заголовками

Поддерживаемые форматы сумм:
- `1 234,56`
- `-1 234,56`
- `+1 234,56`
- `1 234,56 руб.`
- `1 234,56 ₽`
- `1,234.56`

## Фильтрация данных

Автоматически исключаются строки содержащие:
- "итого", "всего", "сумма", "total"
- "остаток", "баланс"
- "выписка сформирована"
- "количество операций"

## Тестирование

Для тестирования HTML парсера:

1. Перейдите на `/test-html-parser`
2. Нажмите "Протестировать HTML парсер"
3. Просмотрите результаты парсинга

Тестовые файлы:
- `/test-data/bank-statement-sample.html` - простая выписка
- `/test-data/bank-statement-complex.html` - сложная выписка

## Ограничения

- Максимальный размер файла: 10MB
- Максимальное количество записей: 10,000
- Требуется наличие таблицы с данными
- HTML должен быть валидным для корректного парсинга

## Рекомендации по использованию

1. **Сохраните HTML выписку** из интернет-банка
2. **Проверьте структуру** - должна быть таблица с транзакциями
3. **Загрузите файл** через интерфейс
4. **Настройте соответствие столбцов** если автоопределение неточное
5. **Просмотрите данные** перед сохранением
6. **Сохраните расходы** в систему

## Поддержка банков

Протестировано с выписками:
- Сбербанк (HTML выписки по картам)
- ВТБ (веб-выписки)
- Альфа-Банк (HTML отчеты)
- Тинькофф (экспорт в HTML)

Если ваш банк не поддерживается, создайте issue с примером HTML файла.